<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Chat App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Chat Container */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .chat-header, .chat-footer {
            background-color: #f8f9fa;
            padding: 15px;
        }
        .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #e9ecef;
        }
        .message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            background-color: #ffffff;
            font-size: 1rem;
            position: relative;
        }
        .message.sent {
            align-self: flex-end;
            background-color: #dcf8c6;
        }
        .message.received {
            align-self: flex-start;
        }
        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: red;
            cursor: pointer;
        }
        .chat-window {
            display: none;
            width: 100%;
            height: 100%;
        }
        .chat-item {
            margin-bottom: 15px;
        }
        .chat-item strong {
            display: block;
        }
        #send-btn {
            font-size: 1rem;
        }
        #message-input {
            font-size: 1rem;
            height: 50px;
        }
    </style>
</head>
<body class="d-flex align-items-center justify-content-center vh-100 bg-light">

    <!-- Container untuk Menampilkan Halaman -->
    <div id="content" class="card shadow-lg p-4 w-100" style="max-width: 1000px;"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
        import { getDatabase, ref, push, onChildAdded, set, get, onValue, remove, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAXwnI8AvjTXl20oJ8hcyhOyvMVsIelvPU",
            authDomain: "gampangajah-716b8.firebaseapp.com",
            databaseURL: "https://gampangajah-716b8-default-rtdb.firebaseio.com",
            projectId: "gampangajah-716b8",
            storageBucket: "gampangajah-716b8.appspot.com",
            messagingSenderId: "996390856094",
            appId: "1:996390856094:web:04ebb3ba9fd7f637d4a28f"
        };

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // Fungsi untuk Mengubah Tampilan Halaman
        window.loadPage = function(page) {
            const content = document.getElementById("content");

            if (page === "login") {
                content.innerHTML = `
                    <h2 class="text-center">Login</h2>
                    <form id="login-form" class="mt-3">
                        <div class="mb-3">
                            <input id="login-username" type="text" class="form-control" placeholder="Username">
                        </div>
                        <div class="mb-3">
                            <input id="login-password" type="password" class="form-control" placeholder="Password">
                        </div>
                        <button type="submit" class="btn btn-success w-100 mb-2">Login</button>
                    </form>
                    <p class="text-center mt-2">Belum punya akun? <a href="#" onclick="event.preventDefault(); loadPage('register')">Daftar</a></p>
                `;

                // Event Listener Login
                document.getElementById("login-form").addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const username = document.getElementById("login-username").value;
                    const password = document.getElementById("login-password").value;

                    try {
                        const userSnapshot = await get(ref(db, `users/${username}`));
                        if (userSnapshot.exists() && userSnapshot.val().password === password) {
                            alert("Login berhasil!");
                            localStorage.setItem("username", username);
                            await update(ref(db, `users/${username}`), { online: true });
                            loadPage("dashboard");
                        } else {
                            alert("Username atau password salah!");
                        }
                    } catch (error) {
                        alert("Error: " + error.message);
                    }
                });

            } else if (page === "register") {
                content.innerHTML = `
                    <h2 class="text-center">Register</h2>
                    <form id="register-form" class="mt-3">
                        <div class="mb-3">
                            <input id="register-username" type="text" class="form-control" placeholder="Username">
                        </div>
                        <div class="mb-3">
                            <input id="register-email" type="email" class="form-control" placeholder="Email">
                        </div>
                        <div class="mb-3">
                            <input id="register-password" type="password" class="form-control" placeholder="Password">
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mb-2">Register</button>
                    </form>
                    <p class="text-center mt-2">Sudah punya akun? <a href="#" onclick="event.preventDefault(); loadPage('login')">Login</a></p>
                `;

                // Event Listener Register
                document.getElementById("register-form").addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const username = document.getElementById("register-username").value;
                    const email = document.getElementById("register-email").value;
                    const password = document.getElementById("register-password").value;

                    try {
                        await createUserWithEmailAndPassword(auth, email, password);
                        await set(ref(db, `users/${username}`), {
                            email: email,
                            password: password,
                            online: false
                        });
                        alert("Akun berhasil dibuat!");
                        loadPage("login");
                    } catch (error) {
                        alert("Error: " + error.message);
                    }
                });

            } else if (page === "dashboard") {
                content.innerHTML = `
                    <h2 class="text-center">Dashboard</h2>
                    <div class="user-list-container">
                        <h5>Pilih Pengguna atau Grup</h5>
                        <button id="group-chat-btn" class="btn btn-primary w-100 mb-3">Masuk ke Grup Diskusi</button>
                        <div id="user-stats" class="mt-3"></div>
                    </div>
                    <div id="chat-box" class="chat-window">
                        <div class="chat-container">
                            <div class="chat-header">
                                <h5 class="mb-0">Chat</h5>
                                <div id="typing-status" class="text-muted"></div>
                            </div>
                            <div id="messages" class="chat-body">
                                <p class="text-muted text-center">Belum ada pesan...</p>
                            </div>
                            <div class="chat-footer">
                                <div class="input-group">
                                    <textarea id="message-input" class="form-control" placeholder="Ketik pesan..."></textarea>
                                    <button id="send-btn" class="btn btn-primary">Kirim</button>
                                    <button id="record-btn" class="btn btn-secondary" disabled>Rekam VN</button>
                                </div>
                            </div>
                            <button id="back-btn" class="btn btn-secondary w-100 mt-3">Kembali</button>
                            <button id="delete-all-btn" class="btn btn-danger w-100 mt-3">Hapus Semua Pesan</button>
                        </div>
                    </div>
                `;

                // Masuk ke grup diskusi
                document.getElementById("group-chat-btn").addEventListener("click", startGroupChat);

                // Masuk ke grup chat
                function startGroupChat() {
                    document.querySelector(".user-list-container").style.display = "none";
                    document.getElementById("chat-box").style.display = "block";
                    loadGroupMessages();
                    updateUserStats();

                    // Kirim Pesan ke Grup
                    document.getElementById("send-btn").addEventListener("click", () => {
                        const messageInput = document.getElementById("message-input");
                        const message = messageInput.value.trim();
                        const fromUsername = localStorage.getItem("username");

                        if (message !== "") {
                            push(ref(db, `groupMessages/`), {
                                text: message,
                                from: fromUsername,
                                timestamp: Date.now()
                            });
                            messageInput.value = "";
                            set(ref(db, `typing/${fromUsername}`), { typing: false });
                        }
                    });

                    // Tampilkan Pesan Grup
                    function loadGroupMessages() {
                        const path = `groupMessages/`;
                        onChildAdded(ref(db, path), (data) => {
                            const messageData = data.val();
                            const messageElement = document.createElement("div");
                            messageElement.classList.add("message");
                            messageElement.innerHTML = `
                                <strong>${messageData.from}</strong>
                                ${messageData.text ? `<p>${messageData.text}</p>` : ''}
                                ${messageData.audioURL ? `<audio controls src="${messageData.audioURL}"></audio>` : ''}
                                ${messageData.from === localStorage.getItem("username") || localStorage.getItem("username") === "bian" ? 
                                    `<button class="delete-btn" data-id="${data.key}">Delete</button>` : ''}
                            `;
                            document.getElementById("messages").appendChild(messageElement);

                            // Event Listener untuk tombol delete
                            if (messageData.from === localStorage.getItem("username") || localStorage.getItem("username") === "bian") {
                                messageElement.querySelector(".delete-btn").addEventListener("click", () => {
                                    deleteMessage(data.key);
                                });
                            }
                        });
                    }

                    // Fungsi untuk menghapus pesan
                    function deleteMessage(messageId) {
                        const currentUser = localStorage.getItem("username");
                        const messageRef = ref(db, `groupMessages/${messageId}`);
                        get(messageRef).then(snapshot => {
                            const messageData = snapshot.val();
                            if (messageData && (messageData.from === currentUser || currentUser === "bian")) {
                                remove(messageRef)
                                    .then(() => {
                                        alert("Pesan berhasil dihapus!");
                                        document.querySelector(`button[data-id="${messageId}"]`).parentElement.remove();
                                    })
                                    .catch((error) => {
                                        alert("Error: " + error.message);
                                    });
                            } else {
                                alert("Anda tidak bisa menghapus pesan orang lain!");
                            }
                        });
                    }

                    // Fungsi untuk menghapus semua pesan
                    document.getElementById("delete-all-btn").addEventListener("click", () => {
                        const currentUser = localStorage.getItem("username");
                        if (currentUser === "bian") {
                            remove(ref(db, `groupMessages/`))
                                .then(() => {
                                    alert("Semua pesan berhasil dihapus!");
                                    document.getElementById("messages").innerHTML = '<p class="text-muted text-center">Belum ada pesan...</p>';
                                })
                                .catch((error) => {
                                    alert("Error: " + error.message);
                                });
                        } else {
                            alert("Anda tidak memiliki izin untuk menghapus semua pesan!");
                        }
                    });

                    // Kembali ke Dashboard
                    document.getElementById("back-btn").addEventListener("click", () => {
                        document.querySelector(".user-list-container").style.display = "block";
                        document.getElementById("chat-box").style.display = "none";
                    });

                    // Rekam Voice Note
                    let mediaRecorder;
                    let audioChunks = [];

                    document.getElementById("record-btn").addEventListener("click", () => {
                        if (mediaRecorder && mediaRecorder.state === "recording") {
                            mediaRecorder.stop();
                        } else {
                            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                                navigator.mediaDevices.getUserMedia({ audio: true })
                                    .then(stream => {
                                        mediaRecorder = new MediaRecorder(stream);
                                        mediaRecorder.start();
                                
                                        mediaRecorder.addEventListener("dataavailable", event => {
                                            audioChunks.push(event.data);
                                        });
                                
                                        mediaRecorder.addEventListener("stop", () => {
                                            const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
                                            audioChunks = [];
                                            uploadAudio(audioBlob);
                                        });
                                    })
                                    .catch(error => {
                                        alert("Error accessing microphone: " + error.message);
                                    });
                            } else {
                                alert("getUserMedia is not supported in this browser.");
                            }
                        }
                    });

                    function uploadAudio(audioBlob) {
                        const fromUsername = localStorage.getItem("username");
                        const audioRef = storageRef(storage, `voiceNotes/${Date.now()}_${fromUsername}.wav`);
                        uploadBytes(audioRef, audioBlob).then(snapshot => {
                            getDownloadURL(snapshot.ref).then(url => {
                                push(ref(db, `groupMessages/`), {
                                    audioURL: url,
                                    from: fromUsername,
                                    timestamp: Date.now()
                                });
                            });
                        });
                    }

                    // Update user stats
                    function updateUserStats() {
                        const userStatsElement = document.getElementById("user-stats");
                        onValue(ref(db, `users`), (snapshot) => {
                            const users = snapshot.val();
                            const totalUsers = Object.keys(users).length;
                            const onlineUsers = Object.values(users).filter(user => user.online).length;
                            userStatsElement.innerHTML = `Total Users: ${totalUsers}, Online Users: ${onlineUsers}`;
                        });
                    }

                    // Typing notification
                    const messageInput = document.getElementById("message-input");
                    messageInput.addEventListener("input", () => {
                        const fromUsername = localStorage.getItem("username");
                        set(ref(db, `typing/${fromUsername}`), { typing: messageInput.value.trim() !== "" });
                    });

                    onValue(ref(db, `typing`), (snapshot) => {
                        const typingUsers = snapshot.val();
                        const typingStatusElement = document.getElementById("typing-status");
                        const typingUsernames = Object.keys(typingUsers).filter(username => typingUsers[username].typing && username !== localStorage.getItem("username"));
                        if (typingUsernames.length > 0) {
                            typingStatusElement.innerHTML = `${typingUsernames.join(", ")} sedang mengetik...`;
                        } else {
                            typingStatusElement.innerHTML = "";
                        }
                    });
                }
            }
        }

        // Mulai dengan halaman login
        loadPage("login");

        // Update user status on page unload
        window.addEventListener("beforeunload", async () => {
            const username = localStorage.getItem("username");
            if (username) {
                await update(ref(db, `users/${username}`), { online: false });
            }
        });
    </script>
</body>
</html>
